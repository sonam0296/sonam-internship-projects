/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("@nguniversal/builders/src/ssr-dev-server/utils", ["require", "exports", "child_process", "net", "rxjs", "rxjs/operators", "tree-kill"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.waitUntilServerIsListening = exports.spawnAsObservable = exports.getAvailablePort = void 0;
    const child_process_1 = require("child_process");
    const net_1 = require("net");
    const rxjs_1 = require("rxjs");
    const operators_1 = require("rxjs/operators");
    const treeKill = require("tree-kill");
    function getAvailablePort() {
        return new Promise((resolve, reject) => {
            const server = net_1.createServer();
            server
                .unref()
                .on('error', reject)
                .listen(0, () => {
                const { port } = server.address();
                server.close(() => resolve(port));
            });
        });
    }
    exports.getAvailablePort = getAvailablePort;
    function spawnAsObservable(command, args = [], options = {}) {
        return new rxjs_1.Observable(obs => {
            const proc = child_process_1.spawn(command, args, options);
            if (proc.stdout) {
                proc.stdout.on('data', data => obs.next({ stdout: data.toString() }));
            }
            if (proc.stderr) {
                proc.stderr.on('data', data => obs.next({ stderr: data.toString() }));
            }
            proc
                .on('error', err => obs.error(err))
                .on('close', code => {
                if (code !== 0) {
                    obs.error(new Error(`${command} exited with ${code} code.`));
                }
                obs.complete();
            });
            return () => {
                if (!proc.killed) {
                    treeKill(proc.pid, 'SIGTERM');
                }
            };
        });
    }
    exports.spawnAsObservable = spawnAsObservable;
    function waitUntilServerIsListening(port, host) {
        const allowedErrorCodes = [
            'ECONNREFUSED',
            'ECONNRESET',
        ];
        return new rxjs_1.Observable(obs => {
            const client = net_1.createConnection({ host, port }, () => {
                obs.next(undefined);
                obs.complete();
            })
                .on('error', err => obs.error(err));
            return () => {
                if (!client.destroyed) {
                    client.destroy();
                }
            };
        })
            .pipe(operators_1.retryWhen(err => err.pipe(operators_1.mergeMap((error, attempts) => {
            return attempts > 10 || !allowedErrorCodes.includes(error.code)
                ? rxjs_1.throwError(error)
                : rxjs_1.timer(100 * (attempts * 1));
        }))));
    }
    exports.waitUntilServerIsListening = waitUntilServerIsListening;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9tb2R1bGVzL2J1aWxkZXJzL3NyYy9zc3ItZGV2LXNlcnZlci91dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7Ozs7Ozs7Ozs7Ozs7SUFFSCxpREFBb0Q7SUFDcEQsNkJBQWtFO0lBQ2xFLCtCQUFxRDtJQUNyRCw4Q0FBcUQ7SUFDckQsc0NBQXNDO0lBRXRDLFNBQWdCLGdCQUFnQjtRQUM5QixPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3JDLE1BQU0sTUFBTSxHQUFHLGtCQUFZLEVBQUUsQ0FBQztZQUM5QixNQUFNO2lCQUNILEtBQUssRUFBRTtpQkFDUCxFQUFFLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQztpQkFDbkIsTUFBTSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUU7Z0JBQ2QsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sQ0FBQyxPQUFPLEVBQWlCLENBQUM7Z0JBQ2pELE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDcEMsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFYRCw0Q0FXQztJQUVELFNBQWdCLGlCQUFpQixDQUMvQixPQUFlLEVBQ2YsT0FBaUIsRUFBRSxFQUNuQixVQUF3QixFQUFFO1FBRTFCLE9BQU8sSUFBSSxpQkFBVSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzFCLE1BQU0sSUFBSSxHQUFHLHFCQUFLLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztZQUMzQyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDdkU7WUFFRCxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDdkU7WUFFRCxJQUFJO2lCQUNELEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNsQyxFQUFFLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFO2dCQUNsQixJQUFJLElBQUksS0FBSyxDQUFDLEVBQUU7b0JBQ2QsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxHQUFHLE9BQU8sZ0JBQWdCLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQztpQkFDOUQ7Z0JBRUQsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2pCLENBQUMsQ0FBQyxDQUFDO1lBRUwsT0FBTyxHQUFHLEVBQUU7Z0JBQ1YsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7b0JBQ2hCLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2lCQUMvQjtZQUNILENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQS9CRCw4Q0ErQkM7SUFFRCxTQUFnQiwwQkFBMEIsQ0FDeEMsSUFBWSxFQUNaLElBQWE7UUFFYixNQUFNLGlCQUFpQixHQUFHO1lBQ3hCLGNBQWM7WUFDZCxZQUFZO1NBQ2IsQ0FBQztRQUVGLE9BQU8sSUFBSSxpQkFBVSxDQUFZLEdBQUcsQ0FBQyxFQUFFO1lBQ3JDLE1BQU0sTUFBTSxHQUFHLHNCQUFnQixDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFLEdBQUcsRUFBRTtnQkFDbkQsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDcEIsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2pCLENBQUMsQ0FBQztpQkFDRCxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBRXBDLE9BQU8sR0FBRyxFQUFFO2dCQUNWLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFO29CQUNyQixNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7aUJBQ2xCO1lBQ0gsQ0FBQyxDQUFDO1FBQ0osQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUNILHFCQUFTLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUN2QixvQkFBUSxDQUFDLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxFQUFFO1lBQzNCLE9BQU8sUUFBUSxHQUFHLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO2dCQUM3RCxDQUFDLENBQUMsaUJBQVUsQ0FBQyxLQUFLLENBQUM7Z0JBQ25CLENBQUMsQ0FBQyxZQUFLLENBQUMsR0FBRyxHQUFHLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEMsQ0FBQyxDQUFDLENBQ0gsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBL0JELGdFQStCQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQgeyBTcGF3bk9wdGlvbnMsIHNwYXduIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgeyBBZGRyZXNzSW5mbywgY3JlYXRlQ29ubmVjdGlvbiwgY3JlYXRlU2VydmVyIH0gZnJvbSAnbmV0JztcbmltcG9ydCB7IE9ic2VydmFibGUsIHRocm93RXJyb3IsIHRpbWVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtZXJnZU1hcCwgcmV0cnlXaGVuIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0ICogYXMgdHJlZUtpbGwgZnJvbSAndHJlZS1raWxsJztcblxuZXhwb3J0IGZ1bmN0aW9uIGdldEF2YWlsYWJsZVBvcnQoKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCBzZXJ2ZXIgPSBjcmVhdGVTZXJ2ZXIoKTtcbiAgICBzZXJ2ZXJcbiAgICAgIC51bnJlZigpXG4gICAgICAub24oJ2Vycm9yJywgcmVqZWN0KVxuICAgICAgLmxpc3RlbigwLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgcG9ydCB9ID0gc2VydmVyLmFkZHJlc3MoKSBhcyBBZGRyZXNzSW5mbztcbiAgICAgICAgc2VydmVyLmNsb3NlKCgpID0+IHJlc29sdmUocG9ydCkpO1xuICAgICAgfSk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3Bhd25Bc09ic2VydmFibGUoXG4gIGNvbW1hbmQ6IHN0cmluZyxcbiAgYXJnczogc3RyaW5nW10gPSBbXSxcbiAgb3B0aW9uczogU3Bhd25PcHRpb25zID0ge31cbik6IE9ic2VydmFibGU8eyBzdGRvdXQ/OiBzdHJpbmcsIHN0ZGVycj86IHN0cmluZyB9PiB7XG4gIHJldHVybiBuZXcgT2JzZXJ2YWJsZShvYnMgPT4ge1xuICAgIGNvbnN0IHByb2MgPSBzcGF3bihjb21tYW5kLCBhcmdzLCBvcHRpb25zKTtcbiAgICBpZiAocHJvYy5zdGRvdXQpIHtcbiAgICAgIHByb2Muc3Rkb3V0Lm9uKCdkYXRhJywgZGF0YSA9PiBvYnMubmV4dCh7IHN0ZG91dDogZGF0YS50b1N0cmluZygpIH0pKTtcbiAgICB9XG5cbiAgICBpZiAocHJvYy5zdGRlcnIpIHtcbiAgICAgIHByb2Muc3RkZXJyLm9uKCdkYXRhJywgZGF0YSA9PiBvYnMubmV4dCh7IHN0ZGVycjogZGF0YS50b1N0cmluZygpIH0pKTtcbiAgICB9XG5cbiAgICBwcm9jXG4gICAgICAub24oJ2Vycm9yJywgZXJyID0+IG9icy5lcnJvcihlcnIpKVxuICAgICAgLm9uKCdjbG9zZScsIGNvZGUgPT4ge1xuICAgICAgICBpZiAoY29kZSAhPT0gMCkge1xuICAgICAgICAgIG9icy5lcnJvcihuZXcgRXJyb3IoYCR7Y29tbWFuZH0gZXhpdGVkIHdpdGggJHtjb2RlfSBjb2RlLmApKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG9icy5jb21wbGV0ZSgpO1xuICAgICAgfSk7XG5cbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgaWYgKCFwcm9jLmtpbGxlZCkge1xuICAgICAgICB0cmVlS2lsbChwcm9jLnBpZCwgJ1NJR1RFUk0nKTtcbiAgICAgIH1cbiAgICB9O1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHdhaXRVbnRpbFNlcnZlcklzTGlzdGVuaW5nKFxuICBwb3J0OiBudW1iZXIsXG4gIGhvc3Q/OiBzdHJpbmcsXG4pOiBPYnNlcnZhYmxlPHVuZGVmaW5lZD4ge1xuICBjb25zdCBhbGxvd2VkRXJyb3JDb2RlcyA9IFtcbiAgICAnRUNPTk5SRUZVU0VEJyxcbiAgICAnRUNPTk5SRVNFVCcsXG4gIF07XG5cbiAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlPHVuZGVmaW5lZD4ob2JzID0+IHtcbiAgICBjb25zdCBjbGllbnQgPSBjcmVhdGVDb25uZWN0aW9uKHsgaG9zdCwgcG9ydCB9LCAoKSA9PiB7XG4gICAgICBvYnMubmV4dCh1bmRlZmluZWQpO1xuICAgICAgb2JzLmNvbXBsZXRlKCk7XG4gICAgfSlcbiAgICAub24oJ2Vycm9yJywgZXJyID0+IG9icy5lcnJvcihlcnIpKTtcblxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBpZiAoIWNsaWVudC5kZXN0cm95ZWQpIHtcbiAgICAgICAgY2xpZW50LmRlc3Ryb3koKTtcbiAgICAgIH1cbiAgICB9O1xuICB9KVxuICAucGlwZShcbiAgICByZXRyeVdoZW4oZXJyID0+IGVyci5waXBlKFxuICAgICAgbWVyZ2VNYXAoKGVycm9yLCBhdHRlbXB0cykgPT4ge1xuICAgICAgICByZXR1cm4gYXR0ZW1wdHMgPiAxMCB8fCAhYWxsb3dlZEVycm9yQ29kZXMuaW5jbHVkZXMoZXJyb3IuY29kZSlcbiAgICAgICAgICA/IHRocm93RXJyb3IoZXJyb3IpXG4gICAgICAgICAgOiB0aW1lcigxMDAgKiAoYXR0ZW1wdHMgKiAxKSk7XG4gICAgICB9KSxcbiAgICApKVxuICApO1xufVxuIl19